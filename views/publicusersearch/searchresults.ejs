<!DOCTYPE html>
<html lang="en">

<head>
  <title>GOV.UK - Public user search page</title>
</head>
    
<link href="/assets/stylesheet/style.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/assets/javascripts/pagination.class.js"></script>
<script type="text/javascript" src="/assets/javascripts/script.js" defer></script>
<link href="/assets/stylesheet/govuk-accordion1.css" rel="stylesheet" media="all" />
<script src="/assets/javascripts/vendor/modernizr.js"></script>

<script type="text/javascript" language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/jquery.cookie/1.4.0/jquery.cookie.min.js"></script>
<script src="https://cdn.jsdelivr.net/alasql/0.3/alasql.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.7.12/xlsx.core.min.js"></script>

  <script>
      window.saveFile = function saveFile (data_request_clientside) {
      console.log(JSON.stringify(data_request_clientside));
      requestUrl = 'https://subsidy-search-service.azurewebsites.net/searchResults';
    
      var api_data;
      $.ajax({
      url: requestUrl,
      type: "POST",
      async: false,
      data: data_request_clientside,
      contentType: 'application/json;charset=utf-8',
      dataType:'json',
      success: function (response) {
          console.log(response);
          api_data = response;
              
      },
      error: function(error){
          console.log("Something went wrong", error);
      }
     });


console.log(JSON.stringify(api_data));
results = JSON.parse(JSON.stringify(api_data));

var innArr = [];
        for (var i = 0; i < results.totalSearchResults; i++)  {
        innArr[innArr.length] = { 
       "Recipient Name": results.awards[i].beneficiary.beneficiaryName,
       "Subsidy purpose" : results.awards[i].subsidyObjective,
       "Spending sector" : results.awards[i].spendingSector,
       "Subsidy type" : results.awards[i].subsidyInstrument,
       "Subsidy date" : results.awards[i].legalGrantingDate,
       "Subsidy name" : results.awards[i].subsidyMeasure.subsidyMeasureTitle,
       "subsidy amount": results.awards[i].subsidyFullAmountExact,
       "subsidy amount range":  results.awards[i].subsidyFullAmountRange                        
           }          
        } 
        var data1 = JSON.parse(JSON.stringify(innArr));
        var data2 = [{a:100,b:10},{a:200,b:20}];
        var opts = [{sheetid:'Subsidy awards',header:true},{sheetid:'Two',header:false}];
        var res = alasql('SELECT * INTO XLSX("SubsidyAwardsDownload.xlsx",?) FROM ?',[opts,[data1,data2]]);             

      }  //end of save file

  
      $(document).ready(function(){
          $('body,html').animate({scrollTop: 300}, 1500); 
      });

  </script>



    <%- include('../partials/header.ejs') %>
    <body class="govuk-template__body app-example-page">
      <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    
    <div class="govuk-width-container ">
      <%- include('../partials/banner.ejs') %>
      <main class="govuk-main-wrapper " id="main-content" role="main">       
        
       <div class="govuk-breadcrumbs ">
         <ol class="govuk-breadcrumbs__list">
           <li class="govuk-breadcrumbs__list-item">
             <a class="govuk-breadcrumbs__link" href="/homepage">Home</a>
           </li>
           <li class="govuk-breadcrumbs__list-item">
             <a class="govuk-breadcrumbs__link" href="/beneficiaryname">Search subsidy awards</a>
           </li>
         </ol>
       </div>
       <br />
       <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
        <h1 class="govuk-fieldset__heading">
          Search results
        </h1>
      </legend>
      <br />
      <div>
      <label class="govuk-label" >
        <%= searchawards.totalSearchResults  %> results
      </label></div>
      <br />


      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds filter-input-div">
          <a href="/filtersearch/?page=1" style="color : black; text-decoration: none">
            <button class="govuk-button  govuk-button--secondary" name="showfiter" value="showfilt">
              Show filters</button>  
          </a>
          <a href="/homepage" style="color : black; text-decoration: none">
            <button class="govuk-button" data-module="govuk-button">New search </button>     
          </a>         
          <!-- <a href="/exportexcel" style="color : black; text-decoration: none"> -->
            <button class="govuk-button" data-module="govuk-button" onclick="saveFile('<%= data_request_clientside %>')"> Download results </button>
           <!-- </a> -->

        </div>

        <div class="govuk-grid-column-one-third ">
        
          <label class="govuk-grid-column-two-thirds">
            Results per page
          </label>
         
         <form class="govuk-grid-column-one-third" action="/pageperroute" method="GET" >  
          <select class="govuk-select" id="sort" name="sort" onchange="this.form.submit()">  
            <% if(frontend_totalRecordsPerPage  == 1) { %>    
              <option value="1" selected>1</option>
            <% } else { %>
            <option value="1">1</option>     
            <% }  %>
            <% if(frontend_totalRecordsPerPage  == 2) { %>  
            <option value="2" selected>2</option>
            <% } else { %>
           <option value="2">2</option>
            <% }  %>
            <% if(frontend_totalRecordsPerPage  == 5) { %> 
            <option value="5" selected>5</option>
            <% } else { %>
            <option value="5">5</option>
            <% }  %>
            <% if(frontend_totalRecordsPerPage  == 10) { %> 
            <option value="10" selected>10</option>
            <% } else { %>
            <option value="10">10</option>
            <% }  %>
          </select>
        </form>
        </div>
      </div>
      
      
      <form action="/homepage" method="POST" > 
      <section>
       <table class="govuk-table">
        <caption class="govuk-table__caption"><h1 class="govuk-fieldset__heading"></h1></caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header" aria-sort="ascending">
              <a href="/pageroute/?page=999997" style="text-decoration: none">
              Recipient Name
              <% if (beneficiary_arrow == "upanddown" ) { %> 
              <img id="updownarrow" src="/assets/images/UpDownArrow.jpg">
              <% } else if (beneficiary_arrow == "downacending" ) { %> 
                <img id="downarrow" src="/assets/images/DownArrow.jpg">
              <% } else { %> 
                <img id="uparrow" src="/assets/images/UpArrow.jpg">
              <% } %>

            </a>
          </th>
          <th scope="col" class="govuk-table__header app-custom-class">Subsidy purpose</th> 
          <th scope="col" class="govuk-table__header app-custom-class">Spending sector</th>
          <th scope="col" class="govuk-table__header app-custom-class">Subsidy type</th>
          <th scope="col" class="govuk-table__header app-custom-class" aria-sort="none">
            <a href="/pageroute/?page=999998" style="text-decoration: none">
            Subsidy date
            <% if (legalgrantingdate_arrow == "upanddown" ) { %> 
              <img id="updownarrow" src="/assets/images/UpDownArrow.jpg">
              <% } else if (legalgrantingdate_arrow == "downacending" ) { %> 
                <img id="downarrow" src="/assets/images/DownArrow.jpg">
              <% } else { %> 
                <img id="uparrow" src="/assets/images/UpArrow.jpg">
              <% } %>
          
          </a></th>


            <th scope="col"  style="text-align:left" class="govuk-table__header app-custom-class" >Subsidy name</th>
            <th scope="col" class="govuk-table__header app-custom-class" aria-sort="none">
              <a href="/pageroute/?page=999999" style="text-decoration: none">
              Subsidy amount
              <% if (subsidyamount_arrow == "upanddown" ) { %> 
                <img id="updownarrow" src="/assets/images/UpDownArrow.jpg">
                <% } else if (subsidyamount_arrow == "downacending" ) { %> 
                  <img id="downarrow" src="/assets/images/DownArrow.jpg">
                <% } else { %> 
                  <img id="uparrow" src="/assets/images/UpArrow.jpg">
                <% } %>
            
            </a>
            </th>
                    
           
         
           
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <% searchawards.awards.forEach(function(item) { %> 
            <tr>
              <td class="govuk-table__cell"><a href="/searchresultsawardroute/?page=<%=item.awardNumber %>" ><%= item.beneficiary.beneficiaryName  %> </a> </td>
              <td class="govuk-table__cell"><%= item.subsidyObjective %></td> 
              <td class="govuk-table__cell"><%= item.spendingSector %></td> 
              <td class="govuk-table__cell"><%= item.subsidyInstrument %></td> 
  
              <td class="govuk-table__cell" style="text-align:center"><%= item.legalGrantingDate%></td> 
              <!-- <td class="govuk-table__cell"><a href="#"><%= item.awardNumber  %> </a> </td> -->
              <td class="govuk-table__cell"><a href="/searchresultsmeasureroute/?page=<%=item.awardNumber %>" ><%= item.subsidyMeasure.subsidyMeasureTitle  %></a></td>
              <% if (item.subsidyInstrument == "Tax measures (tax credit, or tax/duty exemption)") { %>
              <td class="govuk-table__cell">£<%= item.subsidyFullAmountRange %></td> 
              <% } else { %>  
              <td class="govuk-table__cell">£<%= item.subsidyFullAmountExact %></td>  
              <% } %>
         
              
            </tr>
  
            <% } ); %>
   
        </tbody>
      </table>
 
      <!-- ********************** -->
      <!-- Pagination starts here -->
      <!-- ********************** -->

          <div id="pagination1" class="pagination">
 
         <% if (pageCount > 1) { %>

          <div class="col first">
          <p class="pagination-label">
              Showing <span><%= start_record %></span> - <span><%= end_record %></span> of <span><%= totalrows %></span>
          </p>
          </div>

         <% } %>


          <div class="col last">
            <% if (pageCount > 1) { %>

              <% if (current_page_active != 1) { %> 
               <a href="/pageroute/?page=1" id="paginationlink" class="first round"><img id="govuk-left-arrow" src="/assets/images/govuk-left-arrow.jpg"></a>
                <a href="/pageroute/?page=<%= previous_page %>" id="paginationlink" class="previous round">Previous Page</a>
               <% } %>
              
                  <% for (var i = start_page; i <= end_page; i++) { %>
                    <% if (current_page_active != i ) { %>
                    <a id="paginationlink" class="round btn-page" href="/pageroute/?page=<%= i %>"><%= i %></a>
                    <% } else { %>
                      <a id="paginationlink" class="round btn-page active" href="/pageroute/?page=<%= i %>"><%= i %></a>
                      <% } %> 
                    <% } %>
                
                    <% if (current_page_active != pageCount) { %> 
                  <a href="/pageroute/?page=<%= next_page %>" id="paginationlink" class="next round">Next Page</a>
                 <a href="/pageroute/?page=<%= pageCount %>" id="paginationlink" class="last round"><img id="govuk-right-arrow" src="/assets/images/govuk-right-arrow.jpg"></a> 
                  <% } %>
            <% } %>
        </div>
       </div>
      
        
     
        
      </section>
     <!-- ********************** -->
      <!-- Pagination ends here -->
      <!-- ********************** -->

        <div>
        
            <button class="govuk-button" data-module="govuk-button">
            New search </button>
              
        </div>
      </form>  

      </main>
    </div>

      <%- include('../partials/footer.ejs') %>
      <script src="/assets/javascripts/vendor/iframeResizer.contentWindow.js"></script>
      <script src="/assets/javascripts/accordion/govuk-frontend.js"></script>
      <script src="/assets/javascripts/accordion/example.js"></script>
      <script type="text/javascript" src="/assets/javascripts/example.js"></script>
      <script type="text/javascript" src="/assets/javascripts/vendor/modernizr.js"></script>
      <script type="text/javascript" src="/assets/javascripts/govuk-frontend-checkbox.js"></script>
      <script type="text/javascript" src="/assets/javascripts/vendor/iframeResizer.contentWindow.js"></script>
  </body>



</html>
    